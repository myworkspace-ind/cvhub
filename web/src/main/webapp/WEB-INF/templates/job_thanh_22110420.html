<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<html lang="en">
<head>
   	 <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job List</title>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    
    <!-- Bootstrap CSS & JS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Các thư viện DataTables -->
    <link href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css" rel="stylesheet">
    
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
	
    <!-- CSS tùy chỉnh cho phân trang -->
    <style>
         /* Tổng quan trang */
        body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 6px 12px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            border: 1px solid #ddd;
        }

        h1 {
            text-align: center;
            color: #007bff;
            margin-bottom: 20px;
            font-size: 2.5rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        /* Bảng DataTables */
        table.dataTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        table.dataTable thead th {
            background-color: #007bff;
            color: white;
            padding: 12px;
            font-size: 1.1em;
            font-weight: bold;
            text-align: center;
            text-transform: uppercase;
            border-bottom: 2px solid #ddd;
        }

        table.dataTable tbody td {
            padding: 10px;
            text-align: center;
            vertical-align: middle;
            font-size: 0.95em;
            color: #555;
        }

        table.dataTable tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        table.dataTable tbody tr:nth-child(odd) {
            background-color: #fff;
        }

        table.dataTable tbody tr:hover {
            background-color: #e3f2fd;
            cursor: pointer;
            transform: scale(1.01);
            transition: all 0.2s ease-in-out;
        }

        /* Hình ảnh logo */
        table.dataTable tbody td img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 6px;
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        table.dataTable tbody td img:hover {
            transform: scale(1.1);
        }

        /* Nút hành động */
        .btn-success {
            padding: 8px 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.15);
        }

        /* Phân trang */
        .dataTables_paginate .paginate_button {
            font-size: 0.85rem;
            padding: 6px 12px;
            margin: 2px;
            border-radius: 5px;
            border: 1px solid #ddd;
            color: #007bff;
            background-color: white;
            transition: all 0.3s ease;
        }

        .dataTables_paginate .paginate_button:hover {
            background-color: #f0f0f0;
            color: #0056b3;
            border-color: #ccc;
        }

        .dataTables_paginate .paginate_button.current {
            background-color: #007bff;
            color: white;
            border: 1px solid #007bff;
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .btn-success {
                font-size: 0.85rem;
            }

            table.dataTable thead th, table.dataTable tbody td {
                font-size: 0.9rem;
                padding: 8px;
            }
        }
        
        /* Thay đổi màu khi rê chuột vào nút phân trang */
		.dataTables_paginate .paginate_button:hover {
		    background-color: #ffffff; /* Màu nền khi rê chuột */
		    color: white; /* Màu chữ khi rê chuột */
		    border-color: #0056b3; /* Màu viền khi rê chuột */
		}
		
		/* Nút phân trang hiện tại (đang chọn) */
		.dataTables_paginate .paginate_button.current {
		    background-color: #0056b3; /* Màu nền nút đang được chọn */
		    color: white; /* Màu chữ nút đang được chọn */
		    border-color: #0056b3; /* Màu viền nút đang được chọn */
		}
		
		/* Tùy chỉnh hiệu ứng chuyển đổi */
		.dataTables_paginate .paginate_button {
		    transition: all 0.3s ease; /* Hiệu ứng mượt khi đổi trạng thái */
}
.table {
        width: 100%;
        margin-bottom: 1rem;
        background-color: transparent;
    }

    .table th {
        padding: 1rem;
        font-weight: 600;
        background-color: #f8f9fa;
    }

    .table td {
        padding: 1rem;
        vertical-align: middle;
    }

    /* Image styles */
    .img-thumbnail {
        border-radius: 6px;
        transition: transform 0.3s ease;
    }

    .img-thumbnail:hover {
        transform: scale(1.1);
    }

    /* Button styles */
    .btn-success {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        transition: all 0.3s ease;
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }

    /* Search input styles */
    .form-control:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    /* Pagination styles */
    .pagination {
        margin-bottom: 0;
    }

    .page-link {
        padding: 0.5rem 0.75rem;
        color: #007bff;
        background-color: #fff;
        border: 1px solid #dee2e6;
    }

    .page-link:hover {
        color: #0056b3;
        background-color: #e9ecef;
        border-color: #dee2e6;
    }

    .page-item.active .page-link {
        background-color: #007bff;
        border-color: #007bff;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .table th, .table td {
            font-size: 0.875rem;
        }
    }
    .badge.bg-info {
    background-color: #17a2b8;
    color: white;
    font-size: 0.875rem;
    padding: 0.5em 0.75em;
    border-radius: 30px;
	}
	.btn-applicant {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background-color: #17a2b8;
    color: white;
    padding: 8px 16px;
    border-radius: 5px;
    text-decoration: none;
    transition: all 0.3s ease;
}

/* Hiệu ứng hover */
	.btn-applicant:hover {
	    background-color: #138496;
	    color: white;
	    transform: translateY(-2px);
	    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
	}
	
	/* Số lượng ứng viên */
	.applicant-count {
	    font-weight: bold;
	    font-size: 14px;
	}
	
	/* Text "applicants" */
	.applicant-text {
	    font-size: 14px;
	}
	
	/* Icon */
	.btn-applicant i {
	    font-size: 14px;
	}
	.modal-lg {
    max-width: 900px;
}

	.modal-header {
	   background-color: #007bff; /* Màu nền của header */
       border-bottom: 2px solid #dee2e6;
	}
	
	.modal-title {
	    font-weight: bold;
	    color: white; /* Màu trắng */
	    text-transform: uppercase; /* Chữ in hoa (nếu cần) */
	}
	
	.table th {
	    background-color: #f8f9fa;
	    font-weight: 600;
	}
	
	.badge {
	    padding: 0.5em 0.8em;
	    font-weight: 500;
	}
	
	.btn-applicant {
	    display: inline-flex;
	    align-items: center;
	    gap: 8px;
	    background-color: #17a2b8;
	    color: white;
	    padding: 8px 16px;
	    border-radius: 5px;
	    border: none;
	    transition: all 0.3s ease;
	}
	
	.btn-applicant:hover {
	    background-color: #138496;
	    color: white;
	    transform: translateY(-2px);
	    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
	}
	
	        
    </style>
</head>
<body>
    <th:block th:include="fragments/hmenu"></th:block>
    <div class="container mt-5">
    <h1 class="text-center text-primary mb-4">Danh sách công việc</h1>
    
    <!-- Search Bar -->
    <div class="row mb-4">
        <div class="col-md-6">
            <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm theo tên công ty hoặc tên công việc">
        </div>
        <div class="col-md-3">
            <select class="form-select" id="locationFilter">
                <option value="">Tất cả địa điểm</option>
                <option th:each="location : ${locations}" 
                        th:value="${location.name}" 
                        th:text="${location.name}"></option>
            </select>
        </div>
        <div class="col-md-3">
        <a th:href="@{/job}" class="btn btn-primary w-100">Tất cả công việc</a>
    </div>
    </div>

    <!-- Table -->
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-light">
			    <tr>
			        <th>Logo</th>
			        <th>Job Title</th>
			        <th>Company Name</th>
			        <th>Location</th>
			        <th>Job Role</th>
			        <th>Experience</th>
			        <th>Salary</th>
			        <th>Applicants</th> <!-- Thêm cột mới -->
			        <th>Action</th>
			    </tr>
			</thead>
			<tbody id="jobTableBody">
			    <tr th:each="job : ${jobrequests}">
			        <td>
			            <img th:src="@{/images/{logoId}(logoId=${job.organization.logoID})}"
			                 alt="Logo" class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover;">
			        </td>
			        <td th:text="${job.title}"></td>
			        <td th:text="${job.organization.title}"></td>
			        <td th:text="${job.location.name}"></td>
			        <td th:text="${job.jobRole.title}"></td>
			        <td th:text="${job.experience} + ' years'"></td>
			        <td th:text="'$' + ${job.salary}"></td>
			        <td class="text-center">
					  <button type="button" 
				        class="btn btn-applicant" 
				       th:onclick="'showApplicants(\'' + @{/job/applicants/} + ${job.id} + '\')'"
				        data-bs-toggle="modal"
				        data-bs-target="#applicantsModal">
				    <i class="fas fa-users"></i>
				    <span class="applicant-count" th:text="${applicationCounts.get(job.id)}"></span>
				    <span class="applicant-text">ứng viên</span>
				</button>

					</td>
			        <td>
				    <a th:href="@{/jobrequests/{id}(id=${job.id})}" class="btn btn-success btn-sm">Chi tiết</a>
				</td>
			    </tr>
			</tbody>
        </table>
    </div>

   <nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
        <!-- Nút Previous -->
        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled' : ''">
            <a class="page-link" 
               th:href="@{/job(page=${currentPage - 1}, 
                          keyword=${keyword}, 
                          location=${selectedLocation})}" 
               tabindex="-1">Trước</a>
        </li>
        
        <!-- Các nút số trang -->
        <li class="page-item" 
            th:each="pageNumber : ${#numbers.sequence(0, totalPages - 1)}"
            th:classappend="${pageNumber == currentPage} ? 'active' : ''">
            <a class="page-link" 
               th:href="@{/job(page=${pageNumber}, 
                          keyword=${keyword}, 
                          location=${selectedLocation})}"
               th:text="${pageNumber + 1}"></a>
        </li>
        
        <!-- Nút Next -->
        <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled' : ''">
            <a class="page-link" 
               th:href="@{/job(page=${currentPage + 1}, 
                          keyword=${keyword}, 
                          location=${selectedLocation})}">Sau</a>
        </li>
    </ul>
</nav>

    <!-- Export Button -->
    <div class="text-center mt-3">
        <button id="exportExcel" class="btn btn-primary">Export to Excel</button>
    </div>
</div>

<<div class="modal fade" id="applicantsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
           <div class="modal-header">
			    <h5 class="modal-title">
			        <span>Danh sách ứng viên</span>
			    </h5>
			    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
            <div class="modal-body">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Họ và Tên</th>
                            <th>Email</th>
                            <th>Số Điện Thoại</th>
                            <th>Trạng Thái</th>
                        </tr>
                    </thead>
                    <tbody id="applicantTableBody">
                        <!-- Dữ liệu ứng viên sẽ được thêm vào đây -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<!-- Add JavaScript for search and export -->
<script>
$(document).ready(function() {
    // Xử lý tìm kiếm
    let searchTimeout;
    $("#searchInput").on("keyup", function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            let keyword = $(this).val().trim();
            let url = new URL(window.location.href);
            let params = new URLSearchParams(url.search);
            
            // Reset các tham số khác
            params.delete('location');
            $("#locationFilter").val(''); // Reset combobox location
            
            if (keyword) {
                params.set('keyword', keyword);
            } else {
                params.delete('keyword');
            }
            params.set('page', '0');
            
            window.location.href = `${url.pathname}?${params}`;
        }, 500);
    });

    // Xử lý lọc theo location
    $("#locationFilter").on("change", function() {
        let location = $(this).val();
        let url = new URL(window.location.href);
        let params = new URLSearchParams(url.search);
        
        // Reset các tham số khác
        params.delete('keyword');
        $("#searchInput").val(''); // Reset ô tìm kiếm
        
        if (location) {
            params.set('location', location);
        } else {
            params.delete('location');
        }
        params.set('page', '0');
        
        window.location.href = `${url.pathname}?${params}`;
    });
});
function showApplicants(apiUrl) {
    // Gọi API lấy danh sách ứng viên
    $.get(apiUrl, function(data) {
        const modalBody = $("#applicantTableBody");
        modalBody.empty(); // Xóa dữ liệu cũ
        
        // Nếu không có ứng viên
        if (data.length === 0) {
            modalBody.append('<tr><td colspan="4" class="text-center">Không có ứng viên nào.</td></tr>');
            return;
        }

        // Hiển thị danh sách ứng viên
        data.forEach(applicant => {
            const row = `
                <tr>
                    <td>${applicant.name}</td>
                    <td>${applicant.email}</td>
                    <td>${applicant.phone}</td>
                    <td>${applicant.status}</td>
                </tr>
            `;
            modalBody.append(row);
        });
    });
}

function s2ab(s) {
    const buf = new ArrayBuffer(s.length);
    const view = new Uint8Array(buf);
    for (let i = 0; i < s.length; i++) {
        view[i] = s.charCodeAt(i) & 0xFF;
    }
    return buf;
}

// Hàm xuất Excel
$("#exportExcel").click(function() {
    // Tạo workbook mới
    const wb = XLSX.utils.book_new();
    
    // Chuẩn bị dữ liệu
    const data = [
        ['Logo', 'Job Title', 'Company Name', 'Location', 'Job Role', 'Experience', 'Salary', 'Applicants'] // headers
    ];
    
    // Lấy dữ liệu từ bảng
    $("#jobTableBody tr:visible").each(function() {
        const rowData = [];
        $(this).find('td').each(function(index) {
            if (index !== 8) { // Bỏ qua cột Action
                let cellData = $(this).text().trim();
                // Xử lý cho cột logo
                if (index === 0) {
                    cellData = ''; // Bỏ qua logo
                }
                rowData.push(cellData);
            }
        });
        data.push(rowData);
    });
    
    // Tạo worksheet
    const ws = XLSX.utils.aoa_to_sheet(data);
    
    // Thiết lập chiều rộng cột
    const colWidths = [
        {wch: 10}, // Logo
        {wch: 30}, // Job Title
        {wch: 30}, // Company Name
        {wch: 20}, // Location
        {wch: 20}, // Job Role
        {wch: 15}, // Experience
        {wch: 15}, // Salary
        {wch: 15}  // Applicants
    ];
    ws['!cols'] = colWidths;
    
    // Thêm worksheet vào workbook
    XLSX.utils.book_append_sheet(wb, ws, "Job List");
    
    // Tạo file Excel với encoding UTF-8
    const wbout = XLSX.write(wb, {
        bookType: 'xlsx',
        type: 'binary',
        bookSST: false
    });
    
    // Tạo Blob với UTF-8 BOM
    const blob = new Blob([s2ab(wbout)], {
        type: 'application/octet-stream'
    });
    
    // Tạo URL và link tải
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'job_list_' + new Date().toISOString().slice(0,10) + '.xlsx';
    
    // Trigger download
    document.body.appendChild(link);
    link.click();
    
    // Cleanup
    setTimeout(function() {
        window.URL.revokeObjectURL(url);
        document.body.removeChild(link);
    }, 0);
});
//Thêm style cho header
const headerStyle = {
    font: { bold: true },
    alignment: { horizontal: 'center' },
    fill: { fgColor: { rgb: "4F81BD" } }
};

// Áp dụng style cho header
const range = XLSX.utils.decode_range(ws['!ref']);
for(let C = range.s.c; C <= range.e.c; ++C) {
    const cell = XLSX.utils.encode_cell({r:0, c:C});
    if(!ws[cell]) continue;
    ws[cell].s = headerStyle;
}

</script>
</body>
</html>
