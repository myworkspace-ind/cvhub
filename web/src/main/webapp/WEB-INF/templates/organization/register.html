<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thông tin nhà tuyển dụng - Smart Recruitment Platform</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link rel="stylesheet"
	th:href="@{/resources/organization/styleRegister.css}" />
</head>
<body>
	<!-- input ẩn để chứa api key gg map -->
	<input type="hidden" id="apiKey" th:value="${apiKey}">
	<div class="container mt-5">
		<div class="row equal-height">
			<div class="col-md-8">
				<div class="form-wrapper">
					<div class="form-container">
						<h2 class="mb-2">
							Chào mừng <span th:text="${userName}"></span>
						</h2>
						<p class="text-success mb-4">Đến với Smart Recruitment
							Platform</p>
						<p class="mb-4">Vui lòng điền các thông tin nhà tuyển dụng bên
							dưới để chúng tôi hỗ trợ bạn tốt hơn:</p>

						<div class="progress mb-4">
							<div class="progress-bar" role="progressbar" style="width: 50%"
								aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
						</div>
						<form th:if="${reg != null}" id="employerForm"
							th:action="@{/registerOrganization}" method="post"
							enctype="multipart/form-data">
							<div class="mb-3">
								<label for="company-name" class="form-label">Tên công
									ty*</label> <input type="text" class="form-control" id="company-name"
									maxlength="254" name="title" required>
							</div>

							<div class="mb-3">
								<label for="location" class="form-label">Địa điểm làm
									việc *</label> <select class="form-select" id="location"
									name="location" required>
									<option selected disabled>Chọn tỉnh/thành phố</option>
									<option th:each="location : ${locations}"
										th:value="${location.name}" th:text="${location.name}"></option>
								</select>
							</div>
							<div class="org-logo">
								<img id="displayImage" style="width: 200px; height: 200px"
									alt="Company logo">
							</div>
							<div class="mb-3">
								<label for="logo" class="form-label">Logo công ty *</label> <input
									onchange="changeImg(event)" type="file" class="form-control"
									id="logo" name="logoFile" accept="image/*" required>
							</div>

							<div class="mb-3">
								<label for="website" class="form-label">Website công ty</label>
								<input type="url" class="form-control" id="website"
									maxlength="254" name="website"
									placeholder="https://example.com">
							</div>

							<div class="mb-3">
								<label for="summary" class="form-label">Tóm tắt công ty
									*</label>
								<textarea class="form-control" id="summary" name="summary"
									maxlength="254" rows="3" required></textarea>
							</div>

							<div class="mb-3">
								<label for="detail" class="form-label">Chi tiết công ty</label>
								<textarea class="form-control" id="detail" name="detail"
									maxlength="254" rows="5"></textarea>
							</div>

							<div class="mb-3">
								<label for="address-input" class="form-label">Nhập địa
									chỉ</label> <input type="text" id="address-input" name="address"
									class="form-control mb-3"
									placeholder="Nhập địa chỉ hoặc kéo thả thẻ định vị trên bản đồ">
								<span id="error-message"
									style="color: red; font-size: 14px; margin-top: 5px; display: none;">Không
									tìm thấy địa chỉ. Vui lòng thử lại.</span>
								<div id="map" style="height: 400px; width: 100%;"></div>
							</div>

							<button type="submit" class="btn btn-primary">Lưu và
								Tiếp tục →</button>
						</form>

						<form th:if="${update != null}" id="employerForm"
							th:action="@{'/organization/update/' + ${org.id}}" method="post"
							enctype="multipart/form-data">
							<div class="mb-3">
								<label for="company-name" class="form-label">Tên công
									ty*</label> <input th:value="${org.title}" type="text"
									class="form-control" maxlength="254" id="company-name"
									name="title" required>
							</div>

							<div class="mb-3">
								<label for="location" class="form-label">Địa điểm làm
									việc *</label> <select class="form-select" id="location"
									name="location" required>
									<option th:each="location : ${locations}"
										th:value="${location.name}" th:text="${location.name}"
										th:selected="${location.name == located}">></option>
								</select>
							</div>
							<div class="mb-3">
								<div class="org-logo">
									<img id="displayImage" style="width: 200px; height: 200px"
										th:src="@{/images/{logoId}(logoId=${org.logoID})}"
										alt="Company logo">
								</div>
								<label for="logo" class="form-label">Logo công ty *</label> <input
									onchange="changeImg(event)" type="file" class="form-control"
									id="logo" name="logoFile" accept="image/*" required>
							</div>

							<div class="mb-3">
								<label for="website" class="form-label">Website công ty</label>
								<input th:value="${org.website}" type="url" maxlength="254"
									class="form-control" id="website" name="website"
									placeholder="https://example.com">
							</div>

							<div class="mb-3">
								<label for="summary" class="form-label">Tóm tắt công ty
									*</label>
								<textarea th:text="${org.summary}" class="form-control"
									maxlength="254" id="summary" name="summary" rows="3" required></textarea>
							</div>

							<div class="mb-3">
								<label for="detail" class="form-label">Chi tiết công ty</label>
								<textarea class="form-control" id="detail" name="detail"
									maxlength="254" rows="5"></textarea>
							</div>

							<div class="mb-3">
								<label for="address-input" class="form-label">Nhập địa
									chỉ</label> <input type="text" id="address-input" name="address"
									class="form-control mb-3"
									placeholder="Nhập địa chỉ hoặc kéo thả thẻ định vị trên bản đồ">
								<span id="error-message"
									style="color: red; font-size: 14px; margin-top: 5px; display: none;">Không
									tìm thấy địa chỉ. Vui lòng thử lại.</span>
								<div id="map" style="height: 400px; width: 100%;"></div>
							</div>

							<button type="submit" class="btn btn-primary">Lưu và
								Tiếp tục →</button>
						</form>
					</div>
				</div>
			</div>
			<div class="col-md-4">
				<div class="illustration">
					<div class="image-container">
						<img
							src="https://tuyendung.topcv.vn/app/_nuxt/img/register.6e7e23e.png"
							alt="Recruitment illustration">
					</div>
				</div>
			</div>
		</div>
	</div>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
	<script>
		function changeImg(event) {
			const file = event.target.files[0];
			if (file) {
				const reader = new FileReader();
				reader.onload = function(e) {
					const img = document.getElementById('displayImage');
					img.src = e.target.result;
				};
				reader.readAsDataURL(file);
			}
		}
	</script>

	<script>
	// Lấy giá trị từ input ẩn
	const apiKey = document.getElementById('apiKey').value;

	// Nếu bạn muốn thay đổi thuộc tính src của một phần tử cụ thể
	const scriptElement = document.createElement('script');
	scriptElement.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap`;
	document.body.appendChild(scriptElement);
</script>

	<script>
        let map, marker, geocoder, debounceTimeout;

        function initMap() {
            const defaultLocation = { lat: 10.762622, lng: 106.660172 }; // Tọa độ mặc định (Hồ Chí Minh)
            geocoder = new google.maps.Geocoder();

            // Tạo bản đồ
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13,
                center: defaultLocation,
            });

            // Tạo thẻ định vị (marker)
            marker = new google.maps.Marker({
                position: defaultLocation,
                map: map,
                draggable: true, // Cho phép kéo thả
            });

            // Lắng nghe sự kiện kéo thả marker
            marker.addListener("dragend", () => {
                const position = marker.getPosition();
                geocodeLatLng(position.lat(), position.lng());
            });

            // Lắng nghe sự kiện nhập địa chỉ với debounce
            document.getElementById("address-input").addEventListener("input", (event) => {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => {
                    const address = event.target.value;
                    geocodeAddress(address);
                }, 500); // Chờ 500ms sau khi người dùng ngừng nhập
            });
        }

        // Chuyển đổi từ địa chỉ sang tọa độ
        function geocodeAddress(address) {
            if (!address.trim()) return; // Không làm gì nếu ô input trống
            const inputElement = document.getElementById("address-input");
            const errorMessage = document.getElementById("error-message");

            geocoder.geocode({ address: address }, (results, status) => {
                if (status === "OK") {
                    const location = results[0].geometry.location;
                    map.setCenter(location);
                    marker.setPosition(location);

                    // Xóa thông báo lỗi và viền đỏ
                    inputElement.style.borderColor = "#ccc";
                    errorMessage.style.display = "none";
                } else {
                    // Hiển thị viền đỏ và thông báo lỗi
                    inputElement.style.borderColor = "red";
                    errorMessage.style.display = "block";
                    console.error("Không tìm thấy địa chỉ:", status);
                }
            });
        }

        // Chuyển đổi từ tọa độ sang địa chỉ
        function geocodeLatLng(lat, lng) {
            const latlng = { lat: lat, lng: lng };
            geocoder.geocode({ location: latlng }, (results, status) => {
                if (status === "OK") {
                    if (results[0]) {
                        const inputElement = document.getElementById("address-input");
                        const errorMessage = document.getElementById("error-message");

                        inputElement.value = results[0].formatted_address;

                        // Xóa thông báo lỗi và viền đỏ
                        inputElement.style.borderColor = "#ccc";
                        errorMessage.style.display = "none";
                    } else {
                        alert("Không tìm thấy địa chỉ");
                    }
                } else {
                    alert("Lỗi khi tìm địa chỉ: " + status);
                }
            });
        }
    </script>
</body>
</html>